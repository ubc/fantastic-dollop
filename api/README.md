### Framework

Major libraries used for this project, for more details, see `requirements.in`

* [FastAPI](https://fastapi.tiangolo.com/) - async python web framework
* Database
  * [SQLAlchemy](https://www.sqlalchemy.org/) - SQL toolkit
  * [encode/databases](https://github.com/encode/databases) - make SQLAlchemy core's expression language async compatible
  * [Alembic](https://alembic.sqlalchemy.org/) - database migration tool build on SQLAlchemy
* [py-miracle](https://github.com/kolypto/py-miracle) - ACL for permissions management

### Setup (Docker)

See the `README.md` file in the parent directory.

###  Setup (Non-Docker)

Unless otherwise noted, commands should be run in the project directory's root (where this README is located).

##### Virtual Environment

[Virtual environments](https://docs.python.org/3/tutorial/venv.html) create an isolated Python environment to avoid dependency conflict issues with other Python projects.

*Create the virtual environment*

    python3 -m venv venv

*Activate the virtual environment*

    source venv/bin/activate

##### Install Dependencies

For initial install:

    pip install -r requirements/base.txt

For subsequent installs, you can use:

    pip-sync 

Note that `pip-sync` will attempt to match `requirements/base.txt` exactly, including removing packages that do no appear in `requirements/base.txt`.

##### Database configuration

A [PostgreSQL](https://www.postgresql.org/) instance is required. Once you have an instance running, create a database with an associated user, then pass on the information to the API server with these environment variables:

* DB_HOST - database server address, e.g.: localhost
* DB_NAME - database name
* DB_USER - database username
* DB_PASSWORD - database password

If you don't want to use environment variables for configuration, then you can edit app.config.EnvConfig's getDbUrl() function to return an appropriate database connection string that's accepted by the SQLAlchemy library.

With the database configured, you can now use alembic to create the database tables:

    alembic upgrade head

##### Start API server

With all the requirements installed, you should be able to start the server with this command:

    uvicorn main:app --reload

The `--reload` option will automatically update the server when the source code changes. By default, it'll be serving on [http://localhost:8000](http://localhost:8000). You can also see the FastAPI autogenerated documentation and API tester pages at [http://localhost:8000/docs](http://localhost:8000/docs) and [http://localhost:8000/redoc](http://localhost:8000/redoc).

A default admin user is available with:

* Username: admin
* Password: admin

##### Add Dependency

If the dependency is needed in production, add it to `requirements/base.in`. If the dependency is only used for testing, add it to `requirements/test.in`. If you do not specify a version limit, then it'll pull in the latest version.

After updating the requirements file, you need to compile and sync it. For example, if you updated `requirements/base.in`, you need to compile `requirements/base.txt` with this command:

    pip-compile requirements/base.in

Then install the new package with:

    pip-sync requirements/base.txt

Note that since `test.in` pulls in `base.in`, if you update `base.in`, you should compile the test requirements too with:

    pip-compile requirements/test.in

##### Upgrade Dependencies

To upgrade a dependency to the latest:

    pip-compile -P <DEPENDENCY_NAME> requirements/base.in

To upgrade a dependency to a specific version:

    pip-compile -P <DEPENDENCY_NAME>==2.0.0 requirements/base.in

### Running Test Cases ###

Docker is required as we use docker to spin up a postgres instance for the application to write to.

Running the test cases also requires additional python dependencies to be installed. We need to install `requirements/test.txt` which contains everything that's in `requirements/base.txt` as well as additional dependencies that are only used for testing.

	pip-sync requirements/test.txt

The test cases are located in the `test/` directory. They can be run by simply executing:

    pytest

### Modifying the Database Schema

See the README in `app/migrations` for instructions on how to write migrations for modifying the database schema.

### Troubleshooting

1. Compilation error caused by missing `wheel` (eg: `bdist_wheel`) when installing packages with `pip`
  This is caused by outdated `pip` or related tools, update them and see if the error goes away:

        pip install --upgrade pip setuptools pip-tools

  If the error goes away, you need to update the dependency versions, or it'll downgrade `pip-tools` when you next run `pip-sync`:

        pip-compile -P pip-tools requirements/base.in

  After upgrading, you might want to rerun the install from scratch by uninstalling everything first:

        pip uninstall -r requirements/base.txt

  Then running the install again:

        pip install -r requirements/base.txt

2. I can't run raw SQL queries against the user table!
  This is because `user` is a keyword that gets translated to the `current_user` function in Postgres. You need to double quote `"user"` so that it treats it as a table. For more detail: https://dba.stackexchange.com/questions/75551/returning-rows-in-postgresql-with-a-table-called-user
